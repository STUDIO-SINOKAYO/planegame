[gd_scene load_steps=3 format=3 uid="uid://dx66sbmfruhvd"]

[ext_resource type="Script" path="res://Level.gd" id="1_7q8xc"]

[sub_resource type="GDScript" id="GDScript_u52ul"]
script/source = "extends CharacterBody2D
class_name PlayerPlane

# Tunable physics parameters - mess with these in the editor
@export var base_speed: float = 200.0           # How fast plane moves right
@export var gravity: float = 100.0              # Downward pull
@export var loop_speed_multiplier: float = 50.0 # Speed bonus per loop
@export var rotation_speed: float = 5.0         # How fast plane rotates to face movement
@export var wind_influence_radius: float = 100.0 # How close to drawn lines to feel wind
@export var wind_force_strength: float = 800.0  # How strong the wind effect is

# Game state stuff
var wind_points = []                # Points from the currently drawn line
var current_speed: float            # Actual speed (base + loop bonuses)
var loop_count: int = 0             # How many loops detected
var ground_level: float = 600.0     # Y position = death
var game_started: bool = false      # Don't move until first line drawn
var debug_wind_info: String = \"\"    # Debug text

signal game_over

func _ready():
	current_speed = base_speed

func _physics_process(delta):
	# Don't move until player draws first line
	if not game_started:
		velocity = Vector2.ZERO
		return
	
	# Core physics: gravity + rightward movement
	velocity.y += gravity * delta
	velocity.x = current_speed
	
	# Apply wind forces from nearby drawn lines (the main mechanic!)
	apply_wind_forces(delta)
	
	# Always point the plane towards where it's moving
	if velocity.length() > 0:
		var target_rotation = velocity.normalized().angle()
		rotation = lerp_angle(rotation, target_rotation, rotation_speed * delta)
	
	move_and_slide()
	
	# Check if we hit the ground = game over
	if global_position.y >= ground_level:
		emit_signal(\"game_over\")

func set_wind_path(points: Array, detected_loops: int = 0):
	# Called when player finishes drawing a line
	wind_points = points.duplicate()
	loop_count = detected_loops
	
	# Start physics on first line drawn
	if not game_started:
		game_started = true
	
	# More loops = faster plane!
	current_speed = base_speed + (loop_count * loop_speed_multiplier)

func apply_wind_forces(delta):
	# This is the core mechanic: drawn lines create wind that pushes the plane around
	# Instead of following paths rigidly, plane gets \"blown\" by nearby line segments
	if wind_points.size() < 2:
		debug_wind_info = \"No wind points\"
		return
	
	var total_wind_force = Vector2.ZERO
	var influences = 0
	var closest_distance = INF
	
	# Check each segment of the drawn line
	for i in range(wind_points.size() - 1):
		var segment_start = wind_points[i]
		var segment_end = wind_points[i + 1]
		
		# Find closest point on this line segment to the plane
		var closest_point = get_closest_point_on_segment(global_position, segment_start, segment_end)
		var distance = global_position.distance_to(closest_point)
		closest_distance = min(closest_distance, distance)
		
		# If close enough, apply wind force
		if distance < wind_influence_radius:
			# Wind direction = along the line segment
			var wind_direction = (segment_end - segment_start).normalized()
			
			# Closer = stronger effect (squared falloff for smooth feel)
			var influence_strength = 1.0 - (distance / wind_influence_radius)
			influence_strength = influence_strength * influence_strength
			
			var wind_force = wind_direction * wind_force_strength * influence_strength
			
			# Extra lift for upward lines (helps counter gravity)
			if wind_direction.y < 0:  # Line goes up
				wind_force.y *= 2.0
			
			total_wind_force += wind_force
			influences += 1
	
	# Debug info for troubleshooting
	debug_wind_info = \"Influences: \" + str(influences) + \" | Closest: \" + str(int(closest_distance)) + \" | Force: \" + str(total_wind_force)
	
	# Apply the wind to plane velocity
	if influences > 0:
		var average_force = total_wind_force / influences
		velocity += average_force * delta

func get_closest_point_on_segment(point: Vector2, segment_start: Vector2, segment_end: Vector2) -> Vector2:
	# Math utility: find closest point on a line segment to the plane
	# Used to calculate how close plane is to each drawn line segment
	var segment = segment_end - segment_start
	var segment_length_squared = segment.length_squared()
	
	if segment_length_squared == 0:
		return segment_start
	
	# Project point onto line and clamp to segment bounds
	var t = (point - segment_start).dot(segment) / segment_length_squared
	t = clamp(t, 0.0, 1.0)  # Keep within segment (not infinite line)
	
	return segment_start + t * segment

func reset_plane():
	# Reset everything for new game
	wind_points.clear()         
	loop_count = 0              
	current_speed = base_speed  
	game_started = false
"

[node name="Level" type="Node2D"]
script = ExtResource("1_7q8xc")

[node name="Plane" type="CharacterBody2D" parent="."]
position = Vector2(72, 407)
script = SubResource("GDScript_u52ul")
wind_influence_radius = 500.0

[node name="PlaneVisual" type="Polygon2D" parent="Plane"]
color = Color(0, 0, 1, 1)
polygon = PackedVector2Array(15, 0, -8, 8, -5, 0, -8, -8)

[node name="Camera2D" type="Camera2D" parent="Plane"]

[node name="UI" type="CanvasLayer" parent="."]

[node name="SettingsButton" type="Button" parent="UI"]
offset_left = 20.0
offset_top = 20.0
offset_right = 80.0
offset_bottom = 80.0
text = "⚙️"
flat = true

[node name="StaminaContainer" type="Control" parent="UI"]
layout_mode = 3
anchors_preset = 1
anchor_left = 1.0
anchor_right = 1.0
offset_left = -220.0
offset_top = 20.0
offset_right = -20.0
offset_bottom = 50.0
grow_horizontal = 0

[node name="StaminaBar" type="ProgressBar" parent="UI/StaminaContainer"]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
value = 100.0
show_percentage = false

[node name="GameOverScreen" type="Control" parent="UI"]
visible = false
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="Background" type="ColorRect" parent="UI/GameOverScreen"]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
color = Color(0, 0, 0, 0.7)

[node name="GameOverLabel" type="Label" parent="UI/GameOverScreen"]
layout_mode = 1
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -100.0
offset_top = -50.0
offset_right = 100.0
offset_bottom = -20.0
grow_horizontal = 2
grow_vertical = 2
text = "GAME OVER"
horizontal_alignment = 1

[node name="RestartButton" type="Button" parent="UI/GameOverScreen"]
layout_mode = 1
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -75.0
offset_top = 10.0
offset_right = 75.0
offset_bottom = 50.0
grow_horizontal = 2
grow_vertical = 2
text = "RESTART"

[node name="SettingsPanel" type="Control" parent="UI"]
visible = false
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="Background" type="ColorRect" parent="UI/SettingsPanel"]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
color = Color(0, 0, 0, 0.8)

[node name="Panel" type="Panel" parent="UI/SettingsPanel"]
layout_mode = 1
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -200.0
offset_top = -150.0
offset_right = 200.0
offset_bottom = 150.0
grow_horizontal = 2
grow_vertical = 2

[node name="SettingsLabel" type="Label" parent="UI/SettingsPanel/Panel"]
layout_mode = 1
anchors_preset = 10
anchor_right = 1.0
offset_bottom = 50.0
grow_horizontal = 2
text = "SETTINGS"
horizontal_alignment = 1
vertical_alignment = 1

[node name="CloseButton" type="Button" parent="UI/SettingsPanel/Panel"]
layout_mode = 1
anchors_preset = 2
anchor_top = 1.0
anchor_bottom = 1.0
offset_left = 150.0
offset_top = -50.0
offset_right = 200.0
offset_bottom = -10.0
grow_vertical = 0
text = "CLOSE"

[node name="Ground" type="ColorRect" parent="."]
anchors_preset = 14
anchor_top = 0.5
anchor_right = 1.0
anchor_bottom = 0.5
offset_top = 565.0
offset_right = 1152.0
offset_bottom = 645.0
grow_horizontal = 2
grow_vertical = 2
size_flags_vertical = 8
color = Color(0.6, 0.3, 0.1, 1)

[node name="ParallaxBackground" type="ParallaxBackground" parent="."]

[connection signal="game_over" from="Plane" to="." method="_on_game_over"]
[connection signal="pressed" from="UI/SettingsButton" to="." method="_on_settings_pressed"]
[connection signal="pressed" from="UI/GameOverScreen/RestartButton" to="." method="_on_restart_pressed"]
[connection signal="pressed" from="UI/SettingsPanel/Panel/CloseButton" to="." method="_on_close_settings_pressed"]
